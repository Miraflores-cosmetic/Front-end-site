# Подарочные сертификаты в Saleor

## Подарочная карта или ваучер?

В Saleor это **ни то, ни другое** в смысле встроенных сущностей:

- **Voucher (ваучер)** — это **промокод на скидку** (процент или фиксированная сумма). Создаётся в разделе «Скидки» и применяется при оформлении заказа. **Не является товаром**, его нельзя «купить» в магазине.
- **Gift Card** в Saleor — это **выпущенная карта с балансом**, которой можно оплатить заказ. Обычно создаётся администратором и выдаётся вручную или по своей логике. Подходит для «выдачи» сертификатов, а не для продажи номинала на сайте.

Для сценария **«пользователь выбирает номинал и покупает сертификат»** в Saleor делают так:

**Подарочный сертификат = обычный товар (Product) с вариантами по номиналам.**

- Один товар, например «Подарочный сертификат».
- Каждый номинал (1000 ₽, 3000 ₽, 5000 ₽ и т.д.) — **отдельный вариант (Variant)** с своей ценой.
- Покупка и оплата идут как у любого другого товара; никаких Gift Card или Voucher для продажи номинала создавать не нужно.

---

## Как создать в дашборде Saleor

1. **Тип товара** (если ещё не создан): Каталог → Типы товаров → «Тип товара: подарочная карта», без доставки.

2. **Категория** (по желанию): например «Подарочные сертификаты».

3. **Каталог → Товары → Добавить товар**
   - Название: например **Подарочный сертификат**
   - Тип товара: выбранный тип «подарочная карта»
   - Категория: при необходимости
   - **Slug:** в части версий дашборда отдельного поля нет — slug подставляется автоматически из названия (например `podarochnyj-sertifikat`). Узнать slug можно: по URL товара в дашборде (часто в конце пути) или в блоке «Поисковая выдача» / SEO, если он есть. Если slug у вас другой — задайте его на фронте в `.env`: **`VITE_GIFT_CERTIFICATE_PRODUCT_SLUG=ваш-slug`** (без пробелов).
   - **Медиа:** у типа «подарочная карта» поле медиа может быть скрыто или в другой вкладке. Если изображения нет — на странице /gift-certificates будет использоваться заглушка.

4. **Варианты = номиналы**
   - Один вариант = один номинал. Сейчас у вас один вариант 500 ₽ — на сайте будет одна карточка «500 ₽».
   - Чтобы сделать несколько номиналов: в карточке товара добавьте ещё варианты (500 ₽, 1000 ₽, 3000 ₽ и т.д.) и задайте цену варианта = номинал.
   - Сохраните товар и опубликуйте в нужном канале.

5. Страница **/gift-certificates** загружает товар по slug (из кода или из `VITE_GIFT_CERTIFICATE_PRODUCT_SLUG`) и показывает по одной карточке на каждый вариант.

---

## Как клиент пользуется сертификатом

Покупка сертификата на сайте — это оплата товара «Подарочный сертификат» с выбранным номиналом. Чтобы клиент мог **потратить** эту сумму в магазине, ему нужно получить **код** и ввести его при следующем заказе.

### Схема

1. **Клиент покупает** сертификат на /gift-certificates → оформляет заказ и оплачивает (как любой товар).
2. **После оплаты** клиенту нужно выдать код:
   - в Saleor создаётся **Voucher** (ваучер) на сумму номинала (фиксированная скидка в рублях);
   - код этого ваучера отправляется клиенту (email, PDF, личный кабинет и т.д.).
3. **При следующей покупке** клиент:
   - добавляет товары в корзину и переходит к оформлению заказа;
   - в блоке **«Добавить промокод или сертификат»** (в корзине или на странице заказа) вводит полученный код;
   - нажимает «Применить» — сумма заказа уменьшается на номинал сертификата (или на остаток, если номинал больше корзины — зависит от настройки ваучера).

То есть **воспользоваться сертификатом = ввести код как промокод** при оформлении заказа. Интерфейс для этого на сайте уже есть.

### Что нужно настроить на бэкенде

- **После оплаты заказа**, в котором есть товар «Подарочный сертификат», нужно:
  - определить номинал (из купленного варианта);
  - создать в Saleor **Voucher** с типом «фиксированная скидка» на эту сумму, один раз использования, и при необходимости привязать к каналу/валюте;
  - отправить клиенту **код ваучера** (письмо, смс, выдача в ЛК и т.д.).

Это можно делать вручную (админ создаёт ваучер и отправляет код) или автоматически (скрипт/плагин/сервис по событию «заказ оплачен» создаёт ваучер и триггерит отправку кода).

---

## Вариант через подарочные карты (Gift Cards) Saleor

**Да, можно реализовать через нативные подарочные карты Saleor.** Тогда код клиент вводит не как промокод, а как **код подарочной карты** (в том же поле «Промокод / сертификат» — Saleor принимает и ваучеры, и коды gift card).

### Как это устроено в Saleor

- В Saleor есть **тип товара (Product Type)** с видом **GIFT_CARD**. Товар такого типа — это «подарочная карта»: при покупке Saleor **сам создаёт** карту с балансом и (при настроенной отправке) отправляет код клиенту.
- **Срок действия**: в настройках подарочных карт задаётся либо «истекает через N дней/месяцев», либо «без срока». То есть **с момента покупки** и **срок истечения задаётся в дашборде** — как вы и хотите.
- Карта создаётся и активируется **в момент покупки** (при завершении чекаута или при fulfillment заказа — зависит от настройки канала), а не «заранее создаём карты и потом активируем».

### Что нужно сделать

1. **Тип товара**
   - В дашборде: **Каталог → Типы товаров** → создать тип с видом **GIFT_CARD** (если такого ещё нет).

2. **Товар «Подарочный сертификат»**
   - Создать товар с этим типом (GIFT_CARD), slug `podarochnyj-sertifikat`.
   - Варианты = номиналы (1000 ₽, 3000 ₽, 5000 ₽ и т.д.), цена варианта = номинал.
   - Настроить остатки (например, не вести учёт — неограниченное количество).

3. **Настройки подарочных карт**
   - **Настройки канала** (или глобальные настройки Gift Card): срок действия — «истекает через N дней/месяцев» или «никогда».
   - При желании — включить автоматическое создание карты при завершении чекаута (`automaticallyFulfillNonShippableGiftCard`).

4. **Страница /gift-certificates**
   - Уже показывает один товар по slug и варианты как карточки. Достаточно в Saleor сделать этот товар типа GIFT_CARD — фронт менять не обязательно.

В итоге: клиент выбирает номинал на /gift-certificates, покупает → Saleor создаёт подарочную карту с этим балансом и сроком из дашборда, при наличии плагина — отправляет код клиенту. Клиент при следующем заказе вводит **код подарочной карты** в «Добавить промокод или сертификат» и списывается баланс карты.

### Про «создаём карты заранее и только потом активируем»

Такой сценарий («создали 100 карт по 3000 ₽, выводим часть на сайт, при покупке только активируем») в стандартном Saleor **нет**. Обычный поток: товар типа GIFT_CARD с вариантами по номиналам → при покупке **создаётся новая** карта с нужным балансом и сразу активна. Если нужен именно пул заранее созданных карт и активация по факту оплаты — это кастомная логика (например, плагин/воркер по событию заказа, который по своей очереди/пулу находит неактивную карту нужного номинала и вызывает `giftCardActivate`).
